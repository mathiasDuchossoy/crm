{% extends '::base.html.twig' %}

{% block body %}
    <section>
        <h1>
            {% block titre %}
            {% endblock %}
        </h1>
    </section>
    <section>
        {#  BLOCK CONTENANT LE FORMULAIRE #}
        {% block formulaire %}
            {% set personalisable =  true %}
            {% include '::flashbags.html.twig' %}
            {{ form_errors(form) }}
            {{ form_start(form) }}
            {% include '::coches_sites.html.twig' %}

            {% set mesSites = form.hebergements %}
            {% set ongletFournisseurs = 1 %}
            {% include '::onglets_sites.html.twig' %}

            <div class="tab-content" style="padding:20px;">
                {% set iSite = 0 %}
                {% for hebergement in form.hebergements %}
                    <div id="data_site_{{ hebergement.vars.value.site.id }}"
                         class="{% if(iSite==0) %}active{% set iSite = 1 %}{% endif %} tab-pane fade in"
                         data-crm="{{ hebergement.vars.value.site.crm | number_format }}">
                        {{ form_row(hebergement.station, { 'attr' : { 'data-unique_block_prefix' : hebergement.station.vars['unique_block_prefix']  }}) }}
                        {{ form_row(hebergement.typesHebergement, { 'attr' : { 'data-unique_block_prefix' : hebergement.typesHebergement.vars['unique_block_prefix']  }}) }}
                        {{ form_row(hebergement.classement, { 'attr' : { 'data-unique_block_prefix' : hebergement.classement.vars['unique_block_prefix']  }}) }}

                        {#{{ form_row(domaine.enneige) }}#}
                        {{ form_row(hebergement.site) }}
                        <ul class="nav nav-tabs">
                            {% set iTraduc = 0 %}
                            {% for traduction in hebergement.traductions %}
                                <li {% if(iTraduc==0) %}class="active"{% set iTraduc = 1 %}{% endif %}>
                                    <a data-toggle="tab"
                                       href="#{{ hebergement.vars.value.site.id }}_{{ traduction.vars.value.langue.id }}">
                                        {# affiche la langue en fonction de la locale#}
                                        {% for traductionLangue in  traduction.vars.value.langue.traductions %}
                                            {% if(traductionLangue.langueTraduction.code == app.request.locale) %}
                                                {{ traductionLangue.libelle }}
                                            {% endif %}
                                        {% endfor %}
                                    </a>
                                </li>
                                {#{{ form_row(traduction) }}#}
                            {% endfor %}
                        </ul>
                        <div class="tab-content">
                            {% set iTraduc = 0 %}
                            {% for traduction in hebergement.traductions %}
                                <div id="{{ hebergement.vars.value.site.id }}_{{ traduction.vars.value.langue.id }}"
                                     class="{% if(iTraduc==0) %}active{% set iTraduc = 1 %}{% endif %} tab-pane fade in">
                                    {% for element in traduction.children %}
                                        {{ form_row(element , { 'attr' : { 'data-unique_block_prefix' : element.vars['unique_block_prefix'] ~ '_' ~ element.parent.vars['value'].langue.code }}) }}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                <div id="data_fournisseurs" class="tab-pane fade">
                    <div class="row">
                        <div class="col-lg-12">
                            <table id="tabFournisseursAssocies" class="table table-striped">
                                <thead>
                                <tr>
                                    <th class="col-lg-11">Enseigne</th>
                                    <th class="col-lg-1">Dissocier</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg-1 col-lg-push-11">
                            <button type="button" class="btn btn-default"
                                    onclick="afficherModalRechercheFournisseurs()">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                        </div>
                    </div>
                    {#{{ dump(form) }}#}
                    {% set nbFournisseurs = 0 %}
                    <div id="form_fournisseurs"
                         data-prototype="{{ form_widget(form.children['fournisseurs'].vars['prototype']) | e }}"
                         class="row">
                        {% for fournisseur in form.fournisseurs %}
                            {{ form_row(fournisseur) }}
                            {% set nbFournisseurs = nbFournisseurs + 1 %}
                        {% endfor %}
                    </div>
                    <div id="nb_fournisseurs" data-index="{{ nbFournisseurs }}">

                    </div>
                </div>
            </div>
            {{ form_row(form.submit) }}
            {{ form_row(form._token) }}
            {{ form_end(form, {'render_rest': false}) }}
        {% endblock %}
    </section>
    <section>
        {% block actions %}

        {% endblock %}
    </section>
    <div id="modal_small" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
         aria-labelledby="mySmallModalLabel">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                    <h4 class="modal-title" id="mySmallModalLabel">Message</h4></div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="modalRechercherFournisseur" tabindex="-1" role="dialog"
         aria-labelledby="modalRechercherFournisseurLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="modalRechercherFournisseurLabel">Rechercher un fournisseur</h4>
                </div>
                <div class="modal-body">
                    <form id="rechercherFournisseur" class="form-horizontal">
                        <div class="row">
                            <div class="col-lg-12">
                                <label for="rechercheFournisseurEnseigne">Enseigne</label> <input
                                        id="rechercheFournisseurEnseigne" name="rechercheFournisseurEnseigne"
                                        type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-2 col-lg-push-9">

                                <button type="button"
                                        onclick="rechercherFournisseursHebergement($('#rechercheFournisseurEnseigne'))"
                                        class="btn btn-default">
                                    Rechercher
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="resultatRechercheFournisseur">

                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        var itemNonPersonalisable = [];
        {#itemNonPersonalisable.push("_domaine_unifie_domaines_entry_domaineParent");#}
        {#{% for langue in langues %}#}
        {#itemNonPersonalisable.push("_domaine_unifie_domaines_entry_traductions_entry_libelle_{{ langue.code }}");#}
        {#itemNonPersonalisable.push("_domaine_unifie_domaines_entry_traductions_entry_affichageTexte_{{ langue.code }}");#}
        {#{% endfor %}#}
        {#var items = [];#}
        {#items.push("_domaine_unifie_domaines_entry_domaineParent");#}
        {#{% for langue in langues %}#}
        {#items.push("_domaine_unifie_domaines_entry_traductions_entry_libelle_{{ langue.code }}");#}
        {#items.push("_domaine_unifie_domaines_entry_traductions_entry_affichageTexte_{{ langue.code }}");#}
        {#{% endfor %}#}
    </script>
    {{ parent() }}
    <script type="text/javascript">
        var fournisseurs = [];
        function afficherModalRechercheFournisseurs() {

            var modal = $('#modalRechercherFournisseur');
            modal.modal().show();
        }
        function rechercherFournisseursHebergement($rechercheFournisseurEnseigne) {

            var $resultatRechercheFournisseur = $('#resultatRechercheFournisseur');
//            lance la requête ajax de recherche des fournisseurs de type hébergement
            $.ajax({
                url: "{{ path('fournisseur_rechercher_type_hebergement') }}",
                type: 'GET',
                data: {'enseigne': $rechercheFournisseurEnseigne.val()},
                dataType: 'json',
                success: function (json) { // quand la réponse de la requete arrive
//                    vide la zone de résultat de recherche
                    $resultatRechercheFournisseur.html('');
//                    test si il y a au moins un résultat
                    if (json.length > 0) {
                        ajouterTableauRechercheFournisseur(json, $resultatRechercheFournisseur);
                    } else {
                        afficheAucunResultat($resultatRechercheFournisseur)
                    }
                }
            });
        }
        function afficheAucunResultat(destination) {
            destination.html($('<div class="row"><div class="col-lg-12">Aucun résultat trouvé</div></div>'));
        }
        //        Création d'un tableau de résultat pour les fournisseurs avec association
        function ajouterTableauRechercheFournisseur(json, destination) {
            //                        création du tableau de résultat
            var table = $('<table class="table-striped table"><thead><tr><th  class="col-lg-11">Enseigne</th><th  class="col-lg-1">Associer</th></tr></thead><tbody></tbody></table>');
            destination.append(table);
//                        balaye les résultats
            $.each(json, function (index, value) {
                ajouterLigneTableauRechercheFournisseur(table, value);
            });
        }
        function ajouterLigneTableauRechercheFournisseur(table, value) {
//                            création de la ligne de résultat
            var ligne = $('<tr id="resultatRechercheFournisseur' + value.id + '" data-enseigne="' + value.enseigne + '"></tr>');
//                            création des colonnes de résultat
            var colonneEnseigne = $('<td>' + value.enseigne + '</td>');
            var colonneAssocier = $('<td><button type="button" onclick="associerFournisseur(' + value.id + ', \'' + value.enseigne + '\')" class="btn btn-default"><span class="glyphicon glyphicon-plus"></span></button></td>');
//                            ajout des colonnes dans la ligne
            ligne.append(colonneEnseigne);
            ligne.append(colonneAssocier);
//                            ajout de la ligne dans le tableau
            table.find('tbody').append(ligne);
        }
        function associerFournisseur(id, label) {
            var present = false;
//            test la presence du fournisseur "id"
            for (var i = 0; i < fournisseurs.length; i++) {
                if (fournisseurs[i] == id) {
                    present = true;
                }
            }
//            si fournisseur id non présent on genere le formulaire et ajoute la ligne au tableau de fournisseurs
            if (present === false) {
                genererFormulaireFournisseurHebergement(id, label);
                ajouterLigneFournisseursAssocies(id);
                fournisseurs.push(id);
            }
        }
        /**
         * retire la ligne du fournisseur id et supprime le formulaire d'association fournisseur/hebergement
         * @param id
         */
        function dissocierFournisseur(id) {
//            recupere l'element nombre fournisseur
            var $nbFournisseurs = $('#nb_fournisseurs');
//            recupère la ligne du fournisseur a dissocier
            var ligne = $('#fournisseurAssocie' + id);
//            recupere le form du fournisseur a dissocier
            var form = $('#fournisseur' + id);
//            supprime le formulaire de la page
            form.remove();
//            supprime la ligne du tableau des fournisseurs associes
            ligne.remove();
//            lit le tableau des fournisseurs associés pour supprimer l'element du tableau
            for (var i = 0; i < fournisseurs.length; i++) {
                if (fournisseurs[i] == id) {
                    fournisseurs.splice(i, 1);
                    break;
                }
            }
//            décrémente le nombre de fournisseurs associés
            $nbFournisseurs.attr('data-index', ($nbFournisseurs.attr('data-index') - 1));
        }
        /**
         * genere le formulaire et incrémente le nombre de fournisseurs associés
         * @param id
         * @param label
         */
        function genererFormulaireFournisseurHebergement(id, label) {
//            récupère l'element contenant le prototype de formulaire fournisseur_hebergement
            var $formFournisseurHebergement = $('#form_fournisseurs');
//            récupère l'élément contenant le nombre de fournisseurs associés
            var $nbFournisseurs = $('#nb_fournisseurs');
//            récupère le prototype du formulaire FournisseurHebergementType
            var formPrototype = $formFournisseurHebergement.attr('data-prototype');
//            mise en forme du formulaire
            var newForm = '<div id="fournisseur' + id + '" class="row"> <div class="row"><p> Fournisseur: ' + label + '</p></div>' + formPrototype.replace(/__name__/g, id) + '</div>';
//            ajoute le formulaire dans la page
            $formFournisseurHebergement.append(newForm);
//            incrémente le nombre de fournisseurs associés
            $nbFournisseurs.attr('data-index', (parseInt($nbFournisseurs.attr('data-index')) + 1));
//            donnes la valeur du fournisseur dans le hidden fournisseur
            $('#hebergement_unifie_fournisseurs_' + id + '_fournisseur').val(id);
        }
        function ajouterLigneFournisseursAssocies(id) {
            var ligne = $('<tr id="fournisseurAssocie' + id + '"></tr>');
            var colonneEnseigne = $('<td>' + $('#resultatRechercheFournisseur' + id).attr('data-enseigne') + '</td>');
            var colonneDissocier = $('<td><button type="button" class="btn-default btn" onclick="dissocierFournisseur(' + id + ')"><span class="glyphicon glyphicon-minus"></span></button></td>');
            ligne.append(colonneEnseigne);
            ligne.append(colonneDissocier);
            $('#tabFournisseursAssocies').append(ligne);
        }
        $(document).ready(function () {
            {% if sitesAEnregistrer is not empty %}

            {% for siteAEnregistrer in sitesAEnregistrer %}
            $("#siteAEnregistrer_{{ siteAEnregistrer }}").prop("checked", true);
            {% endfor %}

            {% else %}

            $("[id^='siteAEnregistrer']").each(function () {
                $(this).prop('checked', true);
            });

            {% endif %}

            {% for site in sites %}
            var contenuOngletSite = $("[id='data_site_" + {{ site.id }} +"']");
            if (!$("#siteAEnregistrer_{{ site.id }}").is(':checked')) {
                $("#onglet_data_site_{{ site.id }}").hide();
                contenuOngletSite.find(':required').each(function () {
                    $(this).attr('required', false);
                    $(this).attr("data-required", "true");
                });
            }

            $("#siteAEnregistrer_{{ site.id }}").change(function () {
                var checked = false;
                $("[id^='siteAEnregistrer_']").each(function () {

                    if ($(this).is(':checked') && $(this).is(':visible')) {
                        checked = true;
                    }
                });

                if (!checked) {
                    var modal = $("#modal_small");
                    modal.find('.modal-title').text("Attention !!!");
                    modal.find('.modal-body').text("attention vous devez selectionner au moins 1 site");
                    modal.modal().show();
                    $(this).prop('checked', true);
                    return false;
                }

                contenuOngletSite = $("[id='data_site_" + $(this).attr('data-site-id') + "']");
                if (!$(this).is(':checked')) {
//                    supprime le required des champs libelle des traductions
                    contenuOngletSite.find(':required').each(function () {
                        $(this).attr('required', false);
                        $(this).attr("data-required", "true");
                    });
                    if ($("#onglet_data_site_{{ site.id }}").hasClass('active')) {

                        $("[id^='data_site_']").each(function (value, element) {

                            if (!$(element).hasClass('active')) {
                                $("#onglet_" + element.id + " a").tab('show');
                                return false;
                            }

                        });
                    }
                    $("#onglet_data_site_" + $(this).attr('data-site-id')).hide();

                } else {
//                    rend les champs libelle des traductions required
                    contenuOngletSite.find('[data-required=\'true\']').each(function () {
                        $(this).attr('required', true);
                    });
                    $("#onglet_data_site_" + $(this).attr('data-site-id')).show();
                }

            });
            {% endfor %}
//            selectionne le premier onglet coché
            var siteIdFirst = $('[id^="siteAEnregistrer_"]:checked').first().attr('data-site-id');
            $("#onglet_data_site_" + siteIdFirst + " a").tab('show');
        });
    </script>
{% endblock %}