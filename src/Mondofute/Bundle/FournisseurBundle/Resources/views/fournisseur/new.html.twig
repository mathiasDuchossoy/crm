{% extends '@MondofuteFournisseur/fournisseur/fiche.html.twig' %}

{% form_theme form 'bootstrap_3_horizontal_layout.html.twig' %}
{% block title %}
    {{ 'création d\un fournisseur' | capitalize }}
{% endblock %}

{% block titre %}
    Création d'un domaine
{% endblock %}
{% block body %}
    <h1>Fournisseur creation</h1>

    {{ form_start(form) }}
    {{ form_row(form.enseigne) }}

    {% for serviceInterlocuteur in serviceInterlocuteurs %}
        <div class="panel panel-primary">
            <div class="panel-heading"><h3 class="panel-title">
                    {% for traduction in  serviceInterlocuteur.traductions %}
                        {% if traduction.langue.code == app.request.locale %}
                            {{ traduction.libelle }}
                        {% endif %}
                    {% endfor %}
                </h3></div>
            <div class="panel-body">
                <table class="table table-striped" id="service_{{ serviceInterlocuteur.id }}"
                       data-service="{{ serviceInterlocuteur.id }}">
                    <tr>
                        <th>Prrenom</th>
                        <th>Fonction</th>
                        <th>Action</th>
                    </tr>
                </table>
                <button id="button_service_{{ serviceInterlocuteur.id }}" type="button" class="btn btn-default"
                        data-toggle="modal"
                        data-service-libelle="{% for traduction in  serviceInterlocuteur.traductions %}{% if traduction.langue.code == app.request.locale %}{{ traduction.libelle }}{% endif %}{% endfor %}"
                        data-service-id="{{ serviceInterlocuteur.id }}"
                        data-target="#interlocuteurModal">
                    Ajouter
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    {% endfor %}

    <input class="btn btn-default" type="submit" value="Créer">

    <ul>
        <li>
            <a href="{{ path('fournisseur_index') }}">Revenir à la liste</a>
        </li>
    </ul>

    {% set interlocuteurs   = form_widget(form.interlocuteurs.vars.prototype ) %}
    {#{% set prenom   = form_row(form.interlocuteurs.vars.prototype.children.prenom) %}#}
    {#{% set service  = form_row(form.interlocuteurs.vars.prototype.children.service) %}#}
    {#{% set fonction = form_row(form.interlocuteurs.vars.prototype.children.fonction) %}#}

    <div id="values-interlocuteurs" style="display: none">

    </div>
    {{ form_widget(form._token) }}
    {{ form_end(form, {'render_rest': false}) }}

    <div class="modal fade" id="interlocuteurModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">New message</h4>
                </div>
                <div class="modal-body">
                    <form id="form-interlocuteur" data-interlocuteur-index="0" data-prototype="{{ interlocuteurs | e }}"
                          class="form-horizontal">
                        {{ interlocuteurs|raw }}
                        {#{{ prenom|raw }}#}
                        {#{{ service|raw }}#}
                        {#{{ fonction|raw }}#}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="ajout_interlocuteur" type="button" data-dismiss="modal" class="btn btn-primary">Ajouter
                        un interlocuteur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="passerelleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">New message</h4>
                </div>
                <div class="modal-body">
                    <form id="form-passerelle" class="form-horizontal">
                        {{ interlocuteurs|raw }}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="ajout_interlocuteur" type="button" data-dismiss="modal" class="btn btn-primary">Ajouter
                        passerelle
                    </button>
                </div>
            </div>
        </div>
    </div>

    {#<span id="interlocuteur-index" data-interlocuteur-index="0"></span>#}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        {#{% for serviceInterlocuteur in serviceInterlocuteurs %}#}
        {#$('#button_service_{{serviceInterlocuteur.id}}').on('show.bs.modal', function (event) {#}
        $('#interlocuteurModal').on('show.bs.modal', function (event) {
            var formInterlocuteur = $('#form-interlocuteur');
            var formProtoype = formInterlocuteur.data('prototype');
            var interlocuteurIndex = formInterlocuteur.data('interlocuteur-index');
            var newForm = formProtoype.replace(/__name__/g, interlocuteurIndex);
            formInterlocuteur.html(newForm);


            var button = $(event.relatedTarget); // Button that triggered the modal
            var service = button.data('service-libelle'); // Extract info from data-* attributes
            var service_id = button.data('service-id'); // Extract info from data-* attributes
            // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
            // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
            var modal = $(this);
            modal.find('.modal-title').text('Nouvel intelocuteur pour le service ' + service);
//            modal.find('.modal-body [id$="prenom"]').val('');
//            modal.find('.modal-body [id$="fonction"]').val('');
            modal.find('.modal-body [id$="service"]').val(service_id);
        });

        $('#ajout_interlocuteur').on('click', function (event) {
//            console.log( $('#interlocuteurModal').find('.modal-body [id$="service"]').val());
            var interlocuteurModal = $('#interlocuteurModal');
            var interlocuteur = {
                prenom: interlocuteurModal.find('.modal-body [id$="prenom"]').val(),
                fonction: interlocuteurModal.find('.modal-body [id$="fonction"]').val(),
                service: interlocuteurModal.find('.modal-body [id$="service"]').val()
            };
            var fonction = '';
            if (interlocuteur.fonction) {
                fonction = interlocuteurModal.find('.modal-body [id$="fonction"] option[value=\'' + interlocuteur.fonction + '\']').text();
            }


            var $formInterlocuteur = $('#form-interlocuteur');
            var $index = $formInterlocuteur.data('interlocuteur-index');

            var buttonModifie = '<button data-target="#interlocuteurModal" data-toggle="modal" id=\'modifie_interlocuteur_' + $index + '\' data-json=\'' + JSON.stringify(interlocuteur) + '\' type=\'button\' class=\'btn btn-default\'>Modifier<span class=\'glyphicon glyphicon-pencil\' aria-hidden=\'true\'></span></button>';

//            console.log(buttonModifie);
            var $addInterlocuteur = $('<td>' + interlocuteur.prenom + '</td><td>' + fonction + '</td><td>' + buttonModifie + '</td>');
            var $newLigne = $('<tr class="success" data-json=\'' + JSON.stringify(interlocuteur) + '\'></tr>').append($addInterlocuteur);
            $('#service_' + interlocuteur.service).append($newLigne);
            attribuerFunctionModificationInterlocuteur($index);

//            console.log ( $indexHolder.data('interlocuteur-index'));
//            $indexHolder.data('interlocuteur-index', $indexHolder.data('interlocuteur-index') + 1);

//            console.log($('#form-interlocuteur').html());
            var $valuesInterlocuteur = $('#values-interlocuteurs');
            $valuesInterlocuteur.append($formInterlocuteur.html());
            $valuesInterlocuteur.find('[id$="' + $index + '_interlocuteur_prenom"]').val(interlocuteur.prenom);
            $valuesInterlocuteur.find('[id$="' + $index + '_interlocuteur_fonction"]').val(interlocuteur.fonction);
            $valuesInterlocuteur.find('[id$="' + $index + '_interlocuteur_service"]').val(interlocuteur.service);
            $formInterlocuteur.data('interlocuteur-index', $index + 1);
//            console.log($valuesInterlocuteur.find('[id$="'+ $index+ '_prenom"]'));
//            console.log(interlocuteur.prenom);
        });

        function attribuerFunctionModificationInterlocuteur(index) {
            $('#modifie_interlocuteur_' + index).on('click', function (event) {

            });
        }

        {#{% endfor %}#}
    </script>
    <script type="text/javascript">
        var $collectionHolder;

        // setup an "add a interlocuteur" link
        var $addInterlocuteurLink = $('<a href="#" class="add_interlocuteur_link">Add a interlocuteur</a>');
        var $newLinkLi = $('<li></li>').append($addInterlocuteurLink);

        jQuery(document).ready(function () {
            // Get the ul that holds the collection of interlocuteurs
            $collectionHolder = $('ul.interlocuteurs');

            // add the "add a interlocuteur" anchor and li to the interlocuteurs ul
            $collectionHolder.append($newLinkLi);

            // count the current form inputs we have (e.g. 2), use that as the new
            // index when inserting a new item (e.g. 2)
            $collectionHolder.data('index', $collectionHolder.find(':input').length);

            $addInterlocuteurLink.on('click', function (e) {
                // prevent the link from creating a "#" on the URL
                e.preventDefault();

                // add a new interlocuteur form (see next code block)
                addInterlocuteurForm($collectionHolder, $newLinkLi);
            });
        });

        function addInterlocuteurForm($collectionHolder, $newLinkLi) {
            // Get the data-prototype explained earlier
            var prototype = $collectionHolder.data('prototype');

            // get the new index
            var index = $collectionHolder.data('index');

            // Replace '__name__' in the prototype's HTML to
            // instead be a number based on how many items we have
            var newForm = prototype.replace(/__name__/g, index);

            // increase the index with one for the next item
            $collectionHolder.data('index', index + 1);

            // Display the form in the page in an li, before the "Add a interlocuteur" link li
            var $newFormLi = $('<li></li>').append(newForm);
            $newLinkLi.before($newFormLi);
        }
    </script>
{% endblock %}
