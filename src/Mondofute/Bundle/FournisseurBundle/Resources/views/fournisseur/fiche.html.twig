{% extends '::base.html.twig' %}

{% block body %}
    <section>
        <h1>
            {% block titre %}
            {% endblock %}
        </h1>
    </section>
    <section>
        {% block formulaire %}
            {% include '::flashbags.html.twig' %}
            {% set countInterlocuteur = 0 %}

            {{ form_start(form) }}
            {{ form_row(form.enseigne) }}
            {{ form_row(form.raisonSociale) }}
            {{ form_row(form.type) }}
            {{ form_row(form.fournisseurParent) }}
            {{ form_row(form.contient) }}
            {{ form_row(form.moyenComs[0] , {'label' : 'Adresse'}) }}

            <div id="interlocuteur_panels">
                {% for serviceInterlocuteur in serviceInterlocuteurs %}
                    <div class="panel panel-primary">
                        <div class="panel-heading"><h3 class="panel-title">
                                {% for traduction in  serviceInterlocuteur.traductions %}
                                    {% if traduction.langue.code == app.request.locale %}
                                        {{ traduction.libelle }}
                                    {% endif %}
                                {% endfor %}
                            </h3></div>
                        <div class="panel-body">
                            <table class="table table-striped" id="service_{{ serviceInterlocuteur.id }}"
                                   data-service="{{ serviceInterlocuteur.id }}">
                                <tr>
                                    <th>Prénom / Nom</th>
                                    <th>Fonction</th>
                                    <th style="width: 225px;">Action</th>
                                </tr>

                                {% for  key, interlocuteur in fournisseur.interlocuteurs %}
                                    {% if interlocuteur.interlocuteur.service.id ==  serviceInterlocuteur.id %}
                                        <tr id="row_interlocuteur_{{ key }}">
                                            <td>{{ interlocuteur.interlocuteur.prenom }} {{ interlocuteur.interlocuteur.nom }}</td>
                                            <td>
                                                {% for traduction in  interlocuteur.interlocuteur.fonction.traductions %}
                                                    {% if traduction.langue.code == app.request.locale %}
                                                        {{ traduction.libelle }}
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <button onclick="afficherModalModificationInterlocuteur( {{ key }} )"
                                                        type='button' class='btn btn-default'> Modifier <span
                                                            class='glyphicon glyphicon-edit' aria-hidden='true'></span>
                                                </button>
                                                <button onclick="supprimerInterlocuteur( {{ key }} )"
                                                        type='button' class='btn btn-default'> Supprimer <span
                                                            class='glyphicon glyphicon-trash' aria-hidden='true'></span>
                                                </button>
                                            </td>
                                        </tr>
                                        {% set countInterlocuteur = countInterlocuteur + 1 %}
                                    {% endif %}
                                {% endfor %}
                            </table>
                            <button type="button" class="btn btn-default"
                                    data-service-libelle="{% for traduction in  serviceInterlocuteur.traductions %}{% if traduction.langue.code == app.request.locale %}{{ traduction.libelle }}{% endif %}{% endfor %}"
                                    data-service-id="{{ serviceInterlocuteur.id }}"
                                    onclick="afficherModalInterlocuteur(this);"
                            >
                                Ajouter
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            {{ form_row(form.submit) }}

            {% set interlocuteurs   = form_widget( form.interlocuteurs.vars.prototype.children['interlocuteur'] ) %}
            {% set moyenComsAdresse = form_row(form.interlocuteurs.vars.prototype.interlocuteur.moyenComs.vars.prototypes.nucleus_moyencombundle_adresse, { 'label' : 'Adresse' }) %}
            {% set moyenComsMail    = form_row(form.interlocuteurs.vars.prototype.interlocuteur.moyenComs.vars.prototypes.nucleus_moyencombundle_email , { 'label' : 'Email' }) %}
            {#{{ dump(form.interlocuteurs.vars.prototype.interlocuteur.moyenComs.vars.prototypes.nucleus_moyencombundle_email) }}#}
            {% set moyenComsFixe    = form_row(form.interlocuteurs.vars.prototype.interlocuteur.moyenComs.vars.prototypes.nucleus_moyencombundle_fixe , { 'label' : 'Télephone __number__' }) %}
            {% set moyenComsMobile  = form_row(form.interlocuteurs.vars.prototype.interlocuteur.moyenComs.vars.prototypes.nucleus_moyencombundle_mobile , { 'label' : 'Mobile' }) %}
            {#{{ dump(form.interlocuteurs.vars.prototype.interlocuteur.moyenComs.vars.prototypes) }}#}
            {#<div id="values-interlocuteurs" style="">#}
            <div id="values-interlocuteurs" style="display: none">
                {% for interlocuteur in form.interlocuteurs %}
                    {% for element in interlocuteur.children %}
                        {{ form_widget(element) }}
                        {#{% for child in element.children %}#}
                        {#{{ dump(child.vars.name) }}#}
                        {#{%  if child.vars.name == 'moyenComs' %}#}
                        {#{{ dump(element.moyenComs) }}#}
                        {#{% for key , moyenCom in element.moyenComs %}#}
                        {#{{ dump(   moyenCom.vars.value) }}#}
                        {#{{ form_row(moyenCom , {'label' : 'test'}) }}#}
                        {#{{ dump(moyenCom.vars.value | format_args) }}#}
                        {#{{ form_row(moyenCom , {'label' :'test'}) }}#}
                        {#{% endfor %}#}
                        {#{% else %}#}
                        {#{{ form_row(child) }}#}
                        {#{% endif %}#}
                        {#{% endfor %}#}
                    {% endfor %}
                {% endfor %}
            </div>
            {{ form_widget(form._token) }}
            {{ form_end(form, {'render_rest': false}) }}

            <div class="modal fade" id="interlocuteurModal" tabindex="-1" role="dialog"
                 aria-labelledby="exampleModalLabel">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Fermer"><span
                                        aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="exampleModalLabel"></h4>
                        </div>
                        <div class="modal-body">
                            <form id="form-interlocuteur" data-interlocuteur-index="{{ countInterlocuteur }}"
                                  data-prototype="{{ interlocuteurs | e }}"
                                  data-prototype_moyen_coms_adresse="{{ moyenComsAdresse | e }}"
                                  data-prototype_moyen_coms_mail="{{ moyenComsMail | e }}"
                                  data-prototype_moyen_coms_tel1="{{ moyenComsFixe | e }}"
                                  data-prototype_moyen_coms_tel2="{{ moyenComsFixe | e }}"
                                  data-prototype_moyen_coms_mobile="{{ moyenComsMobile | e }}"
                                  class="form-horizontal">
                                {#{{ interlocuteurs|raw }}#}
                                {#{{ prenom|raw }}#}
                                {#{{ service|raw }}#}
                                {#{{ fonction|raw }}#}
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                            {#<button onclick="ajouterInterlocuteur();" id="ajout_interlocuteur" type="button" data-dismiss="modal" class="btn btn-primary">#}
                            <button onclick="ajouterInterlocuteur();" id="enregistrer_interlocuteur" type="button"
                                    class="btn btn-primary">
                                {#data-dismiss="modal" class="btn btn-primary">#}
                                Ajouter
                                un interlocuteur
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        {% endblock %}
    </section>
    <section>
        {% block actions %}

        {% endblock %}
    </section>
    {#<div id="modal_small" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"#}
    {#aria-labelledby="mySmallModalLabel">#}
    {#<div class="modal-dialog modal-sm">#}
    {#<div class="modal-content">#}
    {#<div class="modal-header">#}
    {#<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span#}
    {#aria-hidden="true">×</span></button>#}
    {#<h4 class="modal-title" id="mySmallModalLabel">Message</h4></div>#}
    {#<div class="modal-body"></div>#}
    {#</div>#}
    {#</div>#}
    {#</div>#}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>

        function refuserToucheEntree(event) {
            // Compatibilité IE / Firefox
            if (!event && window.event) {
                event = window.event;
            }
            // IE
            if (event.keyCode == 13) {
                event.returnValue = false;
                event.cancelBubble = true;
            }
            // DOM
            if (event.which == 13) {
                event.preventDefault();
                event.stopPropagation();
            }
        }

        function afficherModalInterlocuteur(element) {
            var $formInterlocuteur = $('#form-interlocuteur');
            var formProtoype = $formInterlocuteur.data('prototype');
            var interlocuteurIndex = $formInterlocuteur.data('interlocuteur-index');
            var newForm = formProtoype.replace(/__name__/g, interlocuteurIndex);
            $formInterlocuteur.html(newForm);

            var $moyenComsInterlocuteur = $('#fournisseur_interlocuteurs_' + interlocuteurIndex + '_interlocuteur_moyenComs');

            var formMoyenComAdressePrototype = $formInterlocuteur.data('prototype_moyen_coms_adresse');
            var newformMoyenComAdresse = formMoyenComAdressePrototype.replace(/__name__/g, interlocuteurIndex);
            newformMoyenComAdresse = newformMoyenComAdresse.replace(/__mycom_name__/g, 0);
            $moyenComsInterlocuteur.html(newformMoyenComAdresse);

            var formMoyenComMailPrototype = $formInterlocuteur.data('prototype_moyen_coms_mail');
            var newformMoyenComMail = formMoyenComMailPrototype.replace(/__name__/g, interlocuteurIndex);
            newformMoyenComMail = newformMoyenComMail.replace(/__mycom_name__/g, 1);
            $moyenComsInterlocuteur.append(newformMoyenComMail);

            var formMoyenComTel1Prototype = $formInterlocuteur.data('prototype_moyen_coms_tel1');
            var newformMoyenComTel1 = formMoyenComTel1Prototype.replace(/__name__/g, interlocuteurIndex);
            newformMoyenComTel1 = newformMoyenComTel1.replace(/__mycom_name__/g, 2);
            newformMoyenComTel1 = newformMoyenComTel1.replace(/__number__/g, 1);
            $moyenComsInterlocuteur.append(newformMoyenComTel1);

            var formMoyenComTel2Prototype = $formInterlocuteur.data('prototype_moyen_coms_tel2');
            var newformmoyenComsFixe2 = formMoyenComTel2Prototype.replace(/__name__/g, interlocuteurIndex);
            newformmoyenComsFixe2 = newformmoyenComsFixe2.replace(/__mycom_name__/g, 3);
            newformmoyenComsFixe2 = newformmoyenComsFixe2.replace(/__number__/g, 2);
            $moyenComsInterlocuteur.append(newformmoyenComsFixe2);

            var formMoyenComMobilePrototype = $formInterlocuteur.data('prototype_moyen_coms_mobile');
            var newformmoyenComsMobile = formMoyenComMobilePrototype.replace(/__name__/g, interlocuteurIndex);
            newformmoyenComsMobile = newformmoyenComsMobile.replace(/__mycom_name__/g, 4);
            $moyenComsInterlocuteur.append(newformmoyenComsMobile);

            $formInterlocuteur.find('input').each(function (index, item) {
                $(item).keypress(function (event) {
                    refuserToucheEntree(event);
                });
            });

            var button = $(element); // Button that triggered the modal

            var service = button.data('service-libelle'); // Extract info from data-* attributes
            var service_id = button.data('service-id'); // Extract info from data-* attributes
            // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
            // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
            var modal = $('#interlocuteurModal');

            $('#enregistrer_interlocuteur').replaceWith($('<button onclick="ajouterInterlocuteur();" id="enregistrer_interlocuteur" type="button" class="btn btn-primary">Ajouterun interlocuteur</button>'));
//                $('#enregistrer_interlocuteur').replaceWith($('<button onclick="ajouterInterlocuteur();" id="enregistrer_interlocuteur" type="button" data-dismiss="modal" class="btn btn-primary">Ajouterun interlocuteur</button>'));
            modal.find('.modal-title').text('Nouvel intelocuteur pour le service ' + service);
            modal.find('.modal-body [id$="service"]').val(service_id);
            modal.modal().show();
        }

        function ajouterInterlocuteur() {

            if (!testRequired()) {
                return false;
            }

            var $interlocuteurModal = $('#interlocuteurModal');
            $interlocuteurModal.modal('hide');

            var interlocuteur = getDataIntelocuteurModal();

            var fonction = '';
            if (interlocuteur.fonction) {
                fonction = $interlocuteurModal.find('.modal-body [id$="fonction"] option[value=\'' + interlocuteur.fonction + '\']').text();
            }

            var $formInterlocuteur = $('#form-interlocuteur');
            var index = $formInterlocuteur.data('interlocuteur-index');

            var buttonModifie = '<button  onclick="afficherModalModificationInterlocuteur(' + index + ');" type=\'button\' class=\'btn btn-default\'>Modifier <span class=\'glyphicon glyphicon-edit\' aria-hidden=\'true\'></span></button>';

            var $addInterlocuteur = $('<td>' + interlocuteur.prenom + ' ' + interlocuteur.nom + '</td><td>' + fonction + '</td><td>' + buttonModifie + ' ' + getButtonSupprimer(index) + '</td>');
            var $newLigne = $('<tr id="row_interlocuteur_' + index + '" class="success"></tr>').append($addInterlocuteur);
            $('#service_' + interlocuteur.service).append($newLigne);

            var $valuesInterlocuteur = $('#values-interlocuteurs');

            $valuesInterlocuteur.append($formInterlocuteur.html());

            setValuesInterlocuteur(interlocuteur, index);

            $formInterlocuteur.data('interlocuteur-index', index + 1);
        }

        function afficherModalModificationInterlocuteur(index) {
            var $interlocuteurModal = $('#interlocuteurModal');
            var $divFournisseurInterlocuteur = $('#fournisseur_interlocuteurs_' + index + '_interlocuteur');

            var interlocuteur = {
                prenom: $divFournisseurInterlocuteur.find('[id$="_prenom"]').val(),
                nom: $divFournisseurInterlocuteur.find('[id$="_nom"]').val(),
                fonction: $divFournisseurInterlocuteur.find('[id$="_fonction"]').val(),
                service: $divFournisseurInterlocuteur.find('[id$="_service"]').val(),
                email: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_1_adresse"]').val(),
                tel1: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_2_numero"]').val(),
                tel2: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_3_numero"]').val(),
                codePostal: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_codePostal"]').val(),
                adresse1: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_adresse1"]').val(),
                adresse2: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_adresse2"]').val(),
                adresse3: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_adresse3"]').val(),
                ville: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_ville"]').val(),
                pays: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_pays"]').val(),
                latitude: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_coordonneeGPS_latitude"]').val(),
                longitude: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_coordonneeGPS_longitude"]').val(),
                precis: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_0_coordonneeGPS_precis"]').val(),
                mobile: $divFournisseurInterlocuteur.find('[id$="_interlocuteur_moyenComs_4_numero"]').val()
            };


            var service = '';
            if (interlocuteur.service) {
                service = $divFournisseurInterlocuteur.find('[id$="service"] option[value=\'' + interlocuteur.service + '\']').text();
            }
            $interlocuteurModal.find('.modal-title').text('Modifier intelocuteur pour le service ' + service);

            $divFournisseurInterlocuteurClone = $divFournisseurInterlocuteur.clone();

            $formInterlocuteur = $('#form-interlocuteur');
            $formInterlocuteur.html($divFournisseurInterlocuteurClone);

            $formInterlocuteur.find('input, select').each(function (index, item) {
                $(item).attr('style', 'border: 1px solid #cccccc;');
                $(item).keypress(function (event) {
                    refuserToucheEntree(event);
                });
            });

            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_prenom"]').val(interlocuteur.prenom);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_nom"]').val(interlocuteur.nom);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_fonction"]').val(interlocuteur.fonction);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_service"]').val(interlocuteur.service);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_1_adresse"]').val(interlocuteur.email);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_2_numero"]').val(interlocuteur.tel1);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_3_numero"]').val(interlocuteur.tel2);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_codePostal"]').val(interlocuteur.codePostal);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_adresse1"]').val(interlocuteur.adresse1);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_adresse2"]').val(interlocuteur.adresse2);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_adresse3"]').val(interlocuteur.adresse3);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_ville"]').val(interlocuteur.ville);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_pays"]').val(interlocuteur.pays);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_coordonneeGPS_latitude"]').val(interlocuteur.latitude);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_coordonneeGPS_longitude"]').val(interlocuteur.longitude);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_coordonneeGPS_precis"]').val(interlocuteur.precis);
            $divFournisseurInterlocuteurClone.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_4_numero"]').val(interlocuteur.mobile);

            $('#enregistrer_interlocuteur').replaceWith($('<button id="enregistrer_interlocuteur" type="button" class="btn btn-primary" onclick="modifierInterlocuteur(\'' + index + '\');">Modifer cet interlocuteur</button>'));

            $interlocuteurModal.modal('show');
        }

        function modifierInterlocuteur(index) {

            if (!testRequired()) {
                return false;
            }
            var $interlocuteurModal = $('#interlocuteurModal');
            $interlocuteurModal.modal('hide');

            var interlocuteur = getDataIntelocuteurModal();

            var fonction = '';
            if (interlocuteur.fonction) {
                fonction = $interlocuteurModal.find('.modal-body [id$="fonction"] option[value=\'' + interlocuteur.fonction + '\']').text();
            }

            var buttonModifie = '<button onclick="afficherModalModificationInterlocuteur(' + index + ');" id=\'modifie_interlocuteur_' + index + '\' \' type=\'button\' class=\'btn btn-default\'>Modifier <span class=\'glyphicon glyphicon-edit\' aria-hidden=\'true\'></span></button>';

            var $addInterlocuteur = $('<td>' + interlocuteur.prenom + ' ' + interlocuteur.nom + '</td><td>' + fonction + '</td><td>' + buttonModifie + ' ' + getButtonSupprimer(index) + '</td>');
            var $newLigne = $('<tr id="row_interlocuteur_' + index + '" class="success"></tr>').append($addInterlocuteur);
            $('#row_interlocuteur_' + index).remove();
            $('#service_' + interlocuteur.service).append($newLigne);

            setValuesInterlocuteur(interlocuteur, index);

            $('#enregistrer_interlocuteur').replaceWith($('<button onclick="ajouterInterlocuteur();" id="enregistrer_interlocuteur" type="button" class="btn btn-primary">Ajouterun interlocuteur</button>'));
        }

        function supprimerInterlocuteur(index) {
            $('#row_interlocuteur_' + index).remove();
            $('#fournisseur_interlocuteurs_' + index + '_interlocuteur').remove();
        }

        function getButtonSupprimer(index) {
            return '<button onclick="supprimerInterlocuteur(' + index + ');" type=\'button\' class=\'btn btn-default\'> Supprimer <span class=\'glyphicon glyphicon-trash\' aria-hidden=\'true\'></span></button>';
        }

        function getDataIntelocuteurModal() {
            var $interlocuteurModal = $('#interlocuteurModal');

            var interlocuteur = {
                prenom: $interlocuteurModal.find('.modal-body [id$="_prenom"]').val(),
                nom: $interlocuteurModal.find('.modal-body [id$="_nom"]').val(),
                fonction: $interlocuteurModal.find('.modal-body [id$="_fonction"]').val(),
                service: $interlocuteurModal.find('.modal-body [id$="_service"]').val(),
                email: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_1_adresse"]').val(),
                tel1: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_2_numero"]').val(),
                tel2: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_3_numero"]').val(),
                codePostal: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_codePostal"]').val(),
                adresse1: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_adresse1"]').val(),
                adresse2: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_adresse2"]').val(),
                adresse3: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_adresse3"]').val(),
                ville: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_ville"]').val(),
                pays: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_pays"]').val(),
                latitude: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_coordonneeGPS_latitude"]').val(),
                longitude: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_coordonneeGPS_longitude"]').val(),
                precis: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_0_coordonneeGPS_precis"]').val(),
                mobile: $interlocuteurModal.find('.modal-body [id$="_interlocuteur_moyenComs_4_numero"]').val()
            };

            return interlocuteur;
        }

        function setValuesInterlocuteur(interlocuteur, index) {
            var $valuesInterlocuteur = $('#values-interlocuteurs');

            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_prenom"]').val(interlocuteur.prenom);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_nom"]').val(interlocuteur.nom);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_fonction"]').val(interlocuteur.fonction);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_service"]').val(interlocuteur.service);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_1_adresse"]').val(interlocuteur.email);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_2_numero"]').val(interlocuteur.tel1);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_3_numero"]').val(interlocuteur.tel2);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_codePostal"]').val(interlocuteur.codePostal);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_adresse1"]').val(interlocuteur.adresse1);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_adresse2"]').val(interlocuteur.adresse2);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_adresse3"]').val(interlocuteur.adresse3);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_ville"]').val(interlocuteur.ville);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_pays"]').val(interlocuteur.pays);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_coordonneeGPS_latitude"]').val(interlocuteur.latitude);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_coordonneeGPS_longitude"]').val(interlocuteur.longitude);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_0_coordonneeGPS_precis"]').val(interlocuteur.precis);
            $valuesInterlocuteur.find('[id$="interlocuteurs_' + index + '_interlocuteur_moyenComs_4_numero"]').val(interlocuteur.mobile);
        }


        var $fournisseur_fournisseurParent = $('#fournisseur_fournisseurParent');

        $fournisseur_fournisseurParent.on('change', function (event) {
            var optionVal = $(event.target).find(":selected").val();
            fournisseurParentSelect(optionVal);
        });

        function fournisseurParentSelect(optionVal) {

            var $fournisseur_contient = $('#fournisseur_contient');
            var $interlocuteur_panels = $('#interlocuteur_panels');
            if (optionVal) {
                $interlocuteur_panels.hide();
                $fournisseur_contient.val(1);
                $fournisseur_contient.find('option:not(:selected)').prop('disabled', 'disabled');
                var $values_interlocuteurs = $('#values-interlocuteurs');
                $values_interlocuteurs.children().each(function (index, element) {
                    var index = element.id.split('_')[2];
                    $('#row_interlocuteur_' + index).remove();
                });
                $values_interlocuteurs.html("");
            }
            else {
                $interlocuteur_panels.show();
                $fournisseur_contient.find('option:not(:selected)').prop('disabled', false);
            }
        }

        var optionVal = $fournisseur_fournisseurParent.find(":selected").val();
        fournisseurParentSelect(optionVal);

        function testRequired() {
            fail = false;
            fail_tab = [];
            $('#form-interlocuteur').find('select, textarea, input').each(function () {
                if (!$(this).prop('required')) {

                } else {
                    if (!$(this).val()) {
                        fail = true;
                        fail_tab.push($(this));
                    }
                    else {
                        $(this).attr('style', 'border: 1px solid green;');
                    }
                }
            });

            //submit if fail never got set to true
            if (!fail) {
                //process form here.
                return true;
            } else {
                var first = true;
                fail_tab.forEach(function ($item) {
                    if (first) {
                        $item.focus();
                        first = false;
                    }
                    // do something with `item`
//                    console.log($item);
                    $item.attr('style', 'border: 1px solid red;')
                });
                return false;
            }
        }


    </script>





{% endblock %}