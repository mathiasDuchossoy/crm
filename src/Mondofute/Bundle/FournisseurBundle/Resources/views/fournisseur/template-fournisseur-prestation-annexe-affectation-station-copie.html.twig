{% if formAjax is defined %}
    {% form_theme form 'bootstrap_3_horizontal_layout.html.twig' %}
{% endif %}

{% set sitesActifs = [] %}
{% if prestationAnnexeFournisseurs is defined %}
    {% for prestationAnnexeFournisseur in prestationAnnexeFournisseurs %}
        {% if prestationAnnexeFournisseur.vars.value.actif == true and (prestationAnnexeFournisseur.vars.value.site.id not in sitesActifs) %}
            {% set sitesActifs = sitesActifs|merge([prestationAnnexeFournisseur.vars.value.site.id]) %}
        {% endif %}
    {% endfor %}
{% endif %}

{% if prestationAnnexeHebergements is defined %}
    {% for prestationAnnexeHebergement in prestationAnnexeHebergements %}
        {% if prestationAnnexeHebergement.vars.value.actif == true and (prestationAnnexeHebergement.vars.value.site.id not in sitesActifs) %}
            {% set sitesActifs = sitesActifs|merge([prestationAnnexeHebergement.vars.value.site.id]) %}
        {% endif %}
    {% endfor %}
{% endif %}
<div id="siteAEnregistrer_{{ prestationAnnexeId }}" xmlns="http://www.w3.org/1999/html">
    {% for site in sites %}
        <span style="{% if site.crm == 1 %}display:none; {% endif %}">
            <label>
                <input id="siteAEnregistrer_{{ prestationAnnexeId }}_{{ site.id }}" data-site-id="{{ site.id }}"
                       type="checkbox" name="sites_{{ prestationAnnexeId }}[]"
                       value="{{ site.id }}"
                        {% if site.crm == 1  or site.id in sitesActifs or sitesActifs is empty %} checked="checked" {% endif %}
                       onclick="return manageSelectionPrestationAnnexeSite('{{ prestationAnnexeId }}' , '{{ site.id }}');"
                /> {{ site.libelle }}</label>
        </span>
    {% endfor %}
</div>
<ul class="nav nav-tabs">
    {% set iSite = 0 %}
    {% for site in sites %}
        <li id="onglet_data_site_{{ prestationAnnexeId }}_{{ site.id }}"
            {% if site.id not in sitesActifs  and sitesActifs is not empty and  site.crm != 1 %}style="display: none" {% endif %}
                {% if(iSite==0) %}class="active"{% set iSite = 1 %}{% endif %}>
            <a data-toggle="tab"
               href="#data_site_{{ prestationAnnexeId }}_{{ site.id }}">
                {{ site.libelle }}
            </a>
        </li>
        {#{% endif %}#}
    {% endfor %}
</ul>
<div class="tab-content" style="padding:20px;">
    {% set iSite = 0 %}
    {% for site in sites %}
        <div id="data_site_{{ prestationAnnexeId }}_{{ site.id }}"
             class="{% if(iSite==0) %}active{% set iSite = 1 %}{% endif %} tab-pane fade in"
                {#data-crm="{{ hebergement.vars.value.site.crm | number_format }}"#}
        >
            {% set stationIdTemp = '' %}
            {% for keyProduit, fournisseurProduit in fournisseurProduits %}
                {% if fournisseurProduit.siteId == site.id %}
                    {% if stationIdTemp !=  fournisseurProduit.stationId %}
                        <fieldset>
                            <legend>
                                <div class="checkbox">
                                    <label><input type="checkbox"
                                                  name="prestation_annexe_affectation_station[{{ prestationAnnexeId }}][{{ fournisseurProduit.stationId }}][{{ fournisseurProduit.id }}][{{ site.id }}]"
                                        >
                                        <a class="collapsed" role="button" data-toggle="collapse"
                                           href="#collapse_station_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}"
                                           aria-controls="collapse_station_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}"
                                                {#onclick="chargerHebergements('{{ prestationAnnexeId }}' , '{{ site.id }}' , '{{ fournisseurProduit.id }}' , '{{ fournisseurProduit.stationId }}');return true;"#}
                                                aria-expanded="
                                                {#{% if hebergementExists == true %}#}
                                                {#true#}
                                                {#{% else %}#}
                                                false
                                                {#{% endif %}#}
                                                "
                                        >
                                            {{ fournisseurProduit.libelle }}
                                        </a>
                                    </label>
                                </div>
                            </legend>
                            <div  id="collapse_station_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}"
                            class="panel-collapse collapse
                                    {#{% if hebergementExists == true %}#}
                                    {#in#}
                                    {#{% endif %}#}
                                " role="tabpanel"
                            aria-labelledby="heading_station_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}">
                    {% endif %}
                    {% set FournisseurExists = false %}
                    {% if prestationAnnexeFournisseurs is defined %}
                        {% for prestationAnnexeFournisseur in prestationAnnexeFournisseurs %}
                            {% if prestationAnnexeFournisseur.vars.value.fournisseur is not null %}
                                {% if prestationAnnexeFournisseur.vars.value.actif == true and prestationAnnexeFournisseur.vars.value.fournisseur.id
                                == fournisseurProduit.id
                                and prestationAnnexeFournisseur.vars.value.site.id == site.id %}
                                    {% set FournisseurExists = true %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% set hebergementExists = false %}
                    {% if hebergements[prestationAnnexeId ~ '_' ~ site.id ~ '_' ~ fournisseurProduit.id ] is defined %}
                        {% set  hebergement = hebergements[prestationAnnexeId ~ '_' ~ site.id ~ '_' ~ fournisseurProduit.id ] %}
                        {% set hebergementExists = true %}
                    {% endif %}
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab"
                                 id="heading_fournisseur_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}_{{ fournisseurProduit.id }}">
                                <h4 class="panel-title">
                                    <div class="checkbox">
                                        <label><input type="checkbox"
                                                    {% if FournisseurExists == true %}
                                                        checked="checked"
                                                    {% endif %}
                                                      name="prestation_annexe_affectation_fournisseur[{{ prestationAnnexeId }}][{{ fournisseurProduit.stationId }}][{{ fournisseurProduit.id }}][{{ site.id }}]"
                                            >
                                            <a class="collapsed" role="button" data-toggle="collapse"
                                               href="#collapse_fournisseur_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}_{{ fournisseurProduit.id }}"
                                               aria-controls="collapse_fournisseur_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}_{{ fournisseurProduit.id }}"
                                               onclick="chargerHebergements('{{ prestationAnnexeId }}' , '{{ site.id }}' , '{{ fournisseurProduit.id }}' , '{{ fournisseurProduit.stationId }}');return true;"
                                               aria-expanded="
                                                {% if hebergementExists == true %}
                                                true
                                                {% else %}
                                                false
                                                {% endif %}
                                           "
                                            >
                                                {{ fournisseurProduit.enseigne }} {{ fournisseurProduit.siteId }} {{ fournisseurProduit.stationId }}
                                            </a>
                                        </label>
                                    </div>
                                </h4>
                            </div>
                            <div id="collapse_fournisseur_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}_{{ fournisseurProduit.id }}"
                                 class="panel-collapse collapse
                                {% if hebergementExists == true %}
                                in
                                {% endif %}
                            " role="tabpanel"
                                 aria-labelledby="heading_fournisseur_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}_{{ fournisseurProduit.id }}">
                                <ul class="list-group"
                                    id="list_hebergements_{{ prestationAnnexeId }}_{{ site.id }}_{{ fournisseurProduit.stationId }}_{{ fournisseurProduit.id }}"
                                >
                                    {% if hebergementExists == true %}
                                        {% include ('@MondofuteFournisseur/fournisseur/template-fournisseur-prestation-annexe-affectation-hebergement.html.twig') with {'siteId' : site.id , 'hebergements' : hebergement} %}
                                    {% endif %}

                                </ul>
                            </div>
                        </div>
                    </div>

                    {% if (fournisseurProduits[keyProduit + 1 ] is not defined)  or  (fournisseurProduits[keyProduit + 1 ].siteId != fournisseurProduit.siteId  or fournisseurProduits[keyProduit + 1 ].stationId != fournisseurProduit.stationId  ) %}
                        {#{{ loop.index + 1  }}#}
                        </div>
                        </fieldset>
                    {% endif %}
                    {% set stationIdTemp = fournisseurProduit.stationId %}
                {% endif %}
            {% endfor %}

        </div>

    {% endfor %}
</div>